<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Had≈æija Bekir - Lov na Cigare</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='20' y='40' width='60' height='20' fill='%23F5F5F5' rx='2'/><rect x='20' y='40' width='15' height='20' fill='%23FF8C00' rx='2'/><rect x='78' y='42' width='4' height='16' fill='%238B7355'/><circle cx='85' cy='50' r='3' fill='%23FF4500'/></svg>" type="image/svg+xml">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a2e; overflow: hidden; touch-action: none; position: fixed; width: 100%; height: 100%; }
        #gameContainer { width: 100%; height: 100%; display: flex; flex-direction: column; position: relative; max-width: 600px; margin: 0 auto; background: linear-gradient(135deg, #8b0000 0%, #dc143c 50%, #8b0000 100%); }
        #stats { background: rgba(139, 0, 0, 0.9); color: #ffd700; padding: 15px; display: flex; flex-direction: column; gap: 10px; font-weight: bold; font-size: 1.1em; border-bottom: 3px solid #ffd700; box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 100; }
        .stats-row { display: flex; justify-content: space-around; }
        .stat-item { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .stat-label { font-size: 0.8em; opacity: 0.9; }
        .stat-value { font-size: 1.3em; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        #spawnTimer { width: 100%; height: 8px; background: rgba(0, 0, 0, 0.3); border-radius: 4px; overflow: hidden; position: relative; }
        #spawnTimerBar { height: 100%; background: linear-gradient(90deg, #ff4500 0%, #ffd700 50%, #32cd32 100%); width: 100%; transition: width 0.1s linear; box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        #spawnTimerText { text-align: center; font-size: 0.75em; opacity: 0.9; margin-top: 2px; }
        #gameCanvas { flex: 1; display: block; width: 100%; cursor: none; background: repeating-linear-gradient(45deg, rgba(139, 0, 0, 0.3) 0px, rgba(139, 0, 0, 0.3) 20px, rgba(178, 34, 34, 0.3) 20px, rgba(178, 34, 34, 0.3) 40px), repeating-linear-gradient(-45deg, rgba(205, 133, 63, 0.2) 0px, rgba(205, 133, 63, 0.2) 20px, rgba(210, 180, 140, 0.2) 20px, rgba(210, 180, 140, 0.2) 40px), radial-gradient(circle at 30% 40%, rgba(139, 69, 19, 0.4) 0%, transparent 50%), radial-gradient(circle at 70% 60%, rgba(160, 82, 45, 0.3) 0%, transparent 50%), linear-gradient(135deg, #8b4513 0%, #a0522d 50%, #8b4513 100%); }
        #bottomControls { background: rgba(139, 0, 0, 0.9); padding: 15px; display: flex; justify-content: center; gap: 10px; border-top: 3px solid #ffd700; z-index: 100; flex-wrap: wrap; }
        button { background: #ffd700; color: #8b0000; border: none; padding: 15px 30px; font-size: 1.1em; font-weight: bold; border-radius: 10px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3); margin: 5px; }
        button:hover { background: #ffed4e; transform: scale(1.05); }
        button:active { transform: scale(0.95); }
        .modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(139, 0, 0, 0.98); border: 4px solid #ffd700; border-radius: 20px; padding: 20px; text-align: center; color: #ffd700; display: none; z-index: 300; box-shadow: 0 10px 40px rgba(0,0,0,0.8); max-width: 95%; max-height: 98%; overflow-y: auto; }
        .modal.show { display: block; animation: popIn 0.5s ease-out; }
        @keyframes popIn { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        .modal h1 { font-size: 2em; margin-bottom: 10px; }
        .modal h2 { font-size: 1.6em; margin-bottom: 10px; }
        .modal p { font-size: 1em; margin: 8px 0; line-height: 1.4; }
        .emoji { font-size: 2em; margin: 8px 0; }
        .instructions { background: rgba(139, 0, 0, 0.8); padding: 20px; border-radius: 15px; margin: 20px 0; max-width: 500px; border: 2px solid #ffd700; }
        .instructions ul { text-align: left; margin: 15px 0; padding-left: 20px; }
        .instructions li { margin: 10px 0; font-size: 1.1em; }
        .menu-items { display: grid; gap: 15px; margin: 20px 0; }
        .menu-item { background: rgba(255, 215, 0, 0.1); border: 2px solid #ffd700; border-radius: 10px; padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.3s; }
        .menu-item:hover { background: rgba(255, 215, 0, 0.3); transform: scale(1.05); }
        .menu-item-name { color: #ffd700; font-size: 1.3em; font-weight: bold; }
        .menu-item-emoji { font-size: 2em; }
        .difficulty-option { background: rgba(255, 215, 0, 0.15); border: 3px solid #ffd700; border-radius: 15px; padding: 25px; margin: 15px 0; cursor: pointer; transition: all 0.3s; max-width: 400px; }
        .difficulty-option:hover { background: rgba(255, 215, 0, 0.3); transform: scale(1.05); }
        .difficulty-title { font-size: 1.8em; font-weight: bold; margin-bottom: 10px; }
        .difficulty-desc { font-size: 1em; opacity: 0.9; margin: 5px 0; }
        .top-list-header { display: grid; grid-template-columns: 50px 1fr 80px; gap: 8px; padding: 10px 15px; background: rgba(255, 215, 0, 0.2); border-radius: 10px; margin-bottom: 10px; font-weight: bold; font-size: 0.9em; }
        .top-list-item { display: grid; grid-template-columns: 50px 1fr 80px; gap: 8px; align-items: center; background: rgba(255, 215, 0, 0.1); border: 2px solid #ffd700; border-radius: 10px; padding: 10px 15px; margin: 8px 0; color: #ffd700; transition: all 0.3s; font-size: 0.85em; }
        .top-list-item:hover { background: rgba(255, 215, 0, 0.2); transform: translateX(5px); }
        .top-list-rank { font-size: 1.6em; font-weight: bold; text-align: center; }
        .top-list-info { display: flex; flex-direction: column; gap: 3px; }
        .top-list-score { font-size: 1.15em; font-weight: bold; }
        .top-list-details { font-size: 0.85em; opacity: 0.8; }
        .top-list-time { text-align: right; font-size: 1em; font-weight: bold; }
        .empty-list { text-align: center; padding: 40px; font-size: 1.2em; opacity: 0.7; }
        #intro { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; color: #ffd700; z-index: 300; padding: 20px; }
        #intro h1 { font-size: 2em; margin-bottom: 20px; text-align: center; }
        #restartOverlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 250; display: none; }
        #restartOverlay.show { display: block; animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; } 50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; } }
        #restartOverlay button { font-size: 1.8em; padding: 25px 50px; background: #ffd700; color: #8b0000; box-shadow: 0 0 30px rgba(255, 215, 0, 0.6); }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="intro">
            <h1>üéÆ Had≈æija Bekir - Lov na Cigare üö¨</h1>
            <div class="instructions">
                <h2 style="text-align: center; margin-bottom: 15px;">üìã Pravila Igre</h2>
                <ul>
                    <li>üéØ Dovedi Had≈æiju do cigare mi≈°em/prstom</li>
                    <li>üî• Cigara se automatski pali i gori</li>
                    <li>üèÉ Veƒáina cigara bje≈æi, 20% ganjaju tebe!</li>
                    <li>‚òï Naruƒçi piƒáe - uhvati ga za +50% cigara!</li>
                    <li>‚è≥ Cilj: Merakaj 60 sekundi i ispu≈°i ≈°to vi≈°e!</li>
                </ul>
            </div>
            <button onclick="showDifficultySelect()" style="font-size: 1.5em; padding: 20px 50px;">üöÄ Poƒçni Igru!</button>
            <button onclick="showTopListFromMenu()" style="font-size: 1.2em; padding: 15px 40px; margin-top: 10px;">üèÜ Top Lista</button>
        </div>

        <div id="difficultySelect" class="modal">
            <h1>Izaberi Te≈æinu</h1>
            <div class="difficulty-option" onclick="startGame('easy')">
                <div class="difficulty-title">‚òï Lahko</div>
                <div class="difficulty-desc">Za poƒçetnike</div>
                <div class="difficulty-desc">40 cigara | +10 svakih 6s | 20% zombi</div>
            </div>
            <div class="difficulty-option" onclick="startGame('hard')">
                <div class="difficulty-title">üî• Evlijanski Nivo</div>
                <div class="difficulty-desc">Za okorjele pu≈°aƒçe</div>
                <div class="difficulty-desc">100 cigara | +50 svakih 6s | 20% zombi</div>
            </div>
            <button onclick="closeDifficultySelect()">Nazad</button>
        </div>

        <div id="stats">
            <div class="stats-row">
                <div class="stat-item"><div class="stat-label">Cigare na hastalu</div><div class="stat-value" id="activeCigars">40</div></div>
                <div class="stat-item"><div class="stat-label">‚è≥</div><div class="stat-value" id="timeLeft">60s</div></div>
                <div class="stat-item"><div class="stat-label">Ispu≈°eno</div><div class="stat-value" id="smokedCigars">0</div></div>
            </div>
            <div><div id="spawnTimer"><div id="spawnTimerBar"></div></div><div id="spawnTimerText">Nove cigare dolaze...</div></div>
        </div>

        <canvas id="gameCanvas"></canvas>

        <div id="restartOverlay">
            <button onclick="restartGame()">üîÑ PROBAJ PONOVO</button>
        </div>

        <div id="bottomControls">
            <button onclick="openKonobarMenu()">‚òï Zovi Konobara</button>
            <button onclick="showTopList()">üèÜ Vidi Top Listu</button>
        </div>

        <div id="konobarMenu" class="modal">
            <h2>üçΩÔ∏è Meni</h2>
            <p style="font-size: 0.85em; opacity: 0.85; margin-bottom: 15px;">Uhvati narud≈æbu za +50% cigara!</p>
            <div class="menu-items">
                <div class="menu-item" onclick="orderItem('Coca Cola', 'ü•§')"><span class="menu-item-name">Coca Cola</span><span class="menu-item-emoji">ü•§</span></div>
                <div class="menu-item" onclick="orderItem('Du≈æa u malu', '‚òï')"><span class="menu-item-name">Du≈æa u malu</span><span class="menu-item-emoji">‚òï</span></div>
                <div class="menu-item" onclick="orderItem('Fokaƒço', 'ü•ñ')"><span class="menu-item-name">Fokaƒço</span><span class="menu-item-emoji">ü•ñ</span></div>
                <div class="menu-item" onclick="orderItem('Limunada', 'üçã')"><span class="menu-item-name">Limunada</span><span class="menu-item-emoji">üçã</span></div>
            </div>
            <button onclick="closeKonobarMenu()">üö¨ Nastavi Pu≈°iti</button>
            <button onclick="endGameFromMenu()">üèÅ Zavr≈°i Igru</button>
        </div>

        <div id="topList" class="modal">
            <h2>üèÜ Top Lista</h2>
            <div class="top-list-header"><div>Rang</div><div>Rezultat</div><div>Vrijeme</div></div>
            <div id="topListContent"></div>
            <button onclick="clearTopScores()" style="background: #dc143c; color: white;">üóëÔ∏è Obri≈°i Top Listu</button>
            <button onclick="closeTopList()">Zatvori</button>
        </div>

        <div id="gameOver" class="modal">
            <div class="emoji">üéâ</div>
            <h1>POBJEDIO SI!</h1>
            <p>Merako si punih 60 sekundi!</p>
            <p id="finalStats"></p>
            <div class="emoji">‚òï</div>
            <p style="font-style: italic;">"Sto bi sad kafa dobro legla!"</p>
            <button onclick="restartGame()">üîÑ Poku≈°aj Ponovo</button>
            <button onclick="showTopListFromGameOver()">üèÜ Vidi Top Listu</button>
            <button onclick="exitToMenu()">üè† Izaƒëi iz Igre</button>
        </div>
    </div>

    <script>
const canvas=document.getElementById('gameCanvas'),ctx=canvas.getContext('2d');
function resizeCanvas(){canvas.width=canvas.offsetWidth;canvas.height=canvas.offsetHeight}
resizeCanvas();window.addEventListener('resize',resizeCanvas);
let topScores=JSON.parse(localStorage.getItem('hadzijaTopScores')||'[]');
const audioContext=new(window.AudioContext||window.webkitAudioContext)();
function playSound(){try{const o=audioContext.createOscillator(),g=audioContext.createGain();o.connect(g);g.connect(audioContext.destination);o.frequency.value=300;o.type='sine';g.gain.setValueAtTime(0.3,audioContext.currentTime);g.gain.exponentialRampToValueAtTime(0.01,audioContext.currentTime+0.5);o.start(audioContext.currentTime);o.stop(audioContext.currentTime+0.5)}catch(e){}}
let gameState={player:{x:0,y:0,radius:35,targetX:0,targetY:0},cigars:[],orderItems:[],smoking:null,smokedCount:0,gameTime:0,maxTime:60,lastSpawnTime:0,isPlaying:false,isPaused:false,gameStartTime:0,currentPhrase:null,phraseCounter:0,difficulty:'easy',orderMessage:null};
const phrases=["E E","Ah Meraka","L.E.","Sarajevski Had≈æiluci","Sto bi sad kafa dobro legla"];
const difficultySettings={easy:{startCigars:40,spawnInterval:6000,spawnCount:10,zombieChance:0.2,tauntChance:0.2},hard:{startCigars:100,spawnInterval:6000,spawnCount:50,zombieChance:0.2,tauntChance:0.02}};

class Cigar{constructor(x,y,d,z=false){this.x=x;this.y=y;this.radius=15;this.speed=1;this.angle=Math.random()*Math.PI*2;this.isSmoking=false;this.smokingProgress=0;this.smokingStartTime=0;this.id=Date.now()+Math.random();const s=difficultySettings[d];this.isZombie=z||Math.random()<s.zombieChance;this.hasTaunt=Math.random()<s.tauntChance;this.tauntText=Math.random()<0.5?"Popu≈°i mene Beka":"I ja sam dijete ovog grada"}
update(px,py){if(this.isSmoking){this.smokingProgress=(Date.now()-this.smokingStartTime)/1000;return}const dx=this.x-px,dy=this.y-py,d=Math.sqrt(dx*dx+dy*dy),m=40,bm=110,cp=50;let pushX=0,pushY=0;if(this.x<cp)pushX=(cp-this.x)*0.1;if(this.x>canvas.width-cp)pushX=-(this.x-(canvas.width-cp))*0.1;if(this.y<cp)pushY=(cp-this.y)*0.1;if(this.y>canvas.height-bm-cp)pushY=-(this.y-(canvas.height-bm-cp))*0.1;if(this.isZombie){const a=Math.atan2(-dy,-dx);this.x+=Math.cos(a)*this.speed*0.5+pushX;this.y+=Math.sin(a)*this.speed*0.5+pushY}else{if(d<200){const fm=Math.max(1,5-(d/40)),fa=Math.atan2(dy,dx);this.x+=Math.cos(fa)*this.speed*fm+pushX;this.y+=Math.sin(fa)*this.speed*fm+pushY}else{this.angle+=(Math.random()-0.5)*0.2;this.x+=Math.cos(this.angle)*this.speed+pushX;this.y+=Math.sin(this.angle)*this.speed+pushY}}if(this.x<m)this.x=m;if(this.x>canvas.width-m)this.x=canvas.width-m;if(this.y<m)this.y=m;if(this.y>canvas.height-bm)this.y=canvas.height-bm}
draw(){ctx.save();ctx.translate(this.x,this.y);if(this.isSmoking){const p=Math.min(this.smokingProgress/2,1),bl=30*p;ctx.fillStyle='#F5F5F5';ctx.fillRect(-15,-4,30-bl,8);ctx.fillStyle='#FF4500';ctx.beginPath();ctx.arc(15-bl,0,2+Math.sin(Date.now()*0.02),0,Math.PI*2);ctx.fill();for(let i=0;i<3;i++){ctx.fillStyle=`rgba(200,200,200,${0.5-p*0.3})`;ctx.beginPath();ctx.arc(15-bl+Math.sin(Date.now()*0.01+i)*5,-10-p*20+i*10,3+i,0,Math.PI*2);ctx.fill()}}else{ctx.fillStyle='#F5F5F5';ctx.fillRect(-15,-4,30,8);ctx.fillStyle='#FF8C00';ctx.fillRect(-15,-4,8,8);ctx.fillStyle='#8B7355';ctx.fillRect(13,-4,2,8);if(this.isZombie){ctx.strokeStyle='rgba(0,255,0,0.8)';ctx.lineWidth=2;ctx.beginPath();ctx.arc(0,0,this.radius+5,0,Math.PI*2);ctx.stroke()}else{const pu=Math.sin(Date.now()*0.003)*0.1+1;ctx.strokeStyle=`rgba(255,215,0,${pu*0.5})`;ctx.lineWidth=2;ctx.beginPath();ctx.arc(0,0,this.radius+5,0,Math.PI*2);ctx.stroke()}if(this.hasTaunt){ctx.font='bold 9px Arial';ctx.textAlign='center';const tw=ctx.measureText(this.tauntText).width;ctx.fillStyle='rgba(255,255,255,0.95)';ctx.fillRect(-tw/2-3,-25,tw+6,14);ctx.strokeStyle='#8B0000';ctx.lineWidth=1.5;ctx.strokeRect(-tw/2-3,-25,tw+6,14);ctx.fillStyle='#8B0000';ctx.fillText(this.tauntText,0,-18)}}ctx.restore()}}

class OrderItem{constructor(x,y,type,emoji){this.x=x;this.y=y;this.type=type;this.emoji=emoji;this.radius=30;this.speed=1.2;this.angle=Math.random()*Math.PI*2;this.collected=false;this.id=Date.now()+Math.random()}
update(px,py){const dx=this.x-px,dy=this.y-py,d=Math.sqrt(dx*dx+dy*dy),m=40,bm=110,cp=50;let pushX=0,pushY=0;if(this.x<cp)pushX=(cp-this.x)*0.1;if(this.x>canvas.width-cp)pushX=-(this.x-(canvas.width-cp))*0.1;if(this.y<cp)pushY=(cp-this.y)*0.1;if(this.y>canvas.height-bm-cp)pushY=-(this.y-(canvas.height-bm-cp))*0.1;if(d<250){const fm=Math.max(1,10-(d/25)),fa=Math.atan2(dy,dx);this.x+=Math.cos(fa)*this.speed*fm+pushX;this.y+=Math.sin(fa)*this.speed*fm+pushY}else{this.angle+=(Math.random()-0.5)*0.3;this.x+=Math.cos(this.angle)*this.speed*1.5+pushX;this.y+=Math.sin(this.angle)*this.speed*1.5+pushY}if(this.x<m)this.x=m;if(this.x>canvas.width-m)this.x=canvas.width-m;if(this.y<m)this.y=m;if(this.y>canvas.height-bm)this.y=canvas.height-bm}
draw(){ctx.save();ctx.translate(this.x,this.y);const pu=Math.sin(Date.now()*0.005)*0.2+1;ctx.strokeStyle=`rgba(255,215,0,${pu*0.7})`;ctx.lineWidth=3;ctx.beginPath();ctx.arc(0,0,this.radius+5,0,Math.PI*2);ctx.stroke();ctx.fillStyle='rgba(255,255,255,0.95)';ctx.beginPath();ctx.arc(0,0,this.radius,0,Math.PI*2);ctx.fill();ctx.strokeStyle='#8B0000';ctx.lineWidth=3;ctx.beginPath();ctx.arc(0,0,this.radius,0,Math.PI*2);ctx.stroke();ctx.font='40px Arial';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(this.emoji,0,0);ctx.restore()}}

function drawPlayer(x,y){ctx.save();ctx.translate(x,y);const s=1.3;ctx.fillStyle='#8B0000';ctx.beginPath();ctx.arc(0,-15*s,18*s,0,Math.PI*2);ctx.fill();ctx.fillStyle='#FFD700';ctx.beginPath();ctx.arc(0,-25*s,6*s,0,Math.PI*2);ctx.fill();ctx.fillStyle='#FDBCB4';ctx.beginPath();ctx.arc(0,0,15*s,0,Math.PI*2);ctx.fill();ctx.strokeStyle='#4A4A4A';ctx.lineWidth=3*s;ctx.beginPath();ctx.moveTo(-10*s,5*s);ctx.quadraticCurveTo(-15*s,3*s,-18*s,5*s);ctx.moveTo(10*s,5*s);ctx.quadraticCurveTo(15*s,3*s,18*s,5*s);ctx.stroke();ctx.fillStyle='#000';ctx.beginPath();ctx.arc(-5*s,-3*s,2*s,0,Math.PI*2);ctx.arc(5*s,-3*s,2*s,0,Math.PI*2);ctx.fill();ctx.strokeStyle='#000';ctx.lineWidth=2*s;ctx.beginPath();ctx.arc(0,2*s,8*s,0.2,Math.PI-0.2);ctx.stroke();ctx.strokeStyle='rgba(255,215,0,0.5)';ctx.lineWidth=3;ctx.beginPath();ctx.arc(0,0,gameState.player.radius+3,0,Math.PI*2);ctx.stroke();ctx.restore()}

function drawBubble(x,y,txt){ctx.save();const p=15,fs=16;ctx.font=`bold ${fs}px Arial`;const tw=ctx.measureText(txt).width,bw=tw+p*2,bh=40,bx=x-bw/2,by=y-100;ctx.fillStyle='rgba(255,255,255,0.95)';ctx.strokeStyle='#8B0000';ctx.lineWidth=3;ctx.beginPath();ctx.roundRect(bx,by,bw,bh,10);ctx.fill();ctx.stroke();ctx.beginPath();ctx.moveTo(x-10,by+bh);ctx.lineTo(x,y-40);ctx.lineTo(x+10,by+bh);ctx.closePath();ctx.fill();ctx.stroke();ctx.fillStyle='#8B0000';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(txt,x,by+bh/2);ctx.restore()}

function drawOrderMessage(x,y,txt){ctx.save();const p=15,fs=18;ctx.font=`bold ${fs}px Arial`;const tw=ctx.measureText(txt).width,bw=tw+p*2,bh=50,bx=x-bw/2,by=y-150;ctx.fillStyle='rgba(255,215,0,0.95)';ctx.strokeStyle='#8B0000';ctx.lineWidth=3;ctx.beginPath();ctx.roundRect(bx,by,bw,bh,10);ctx.fill();ctx.stroke();ctx.fillStyle='#8B0000';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(txt,x,by+bh/2);ctx.restore()}

function spawnCigars(n,z=false){for(let i=0;i<n;i++){if(gameState.cigars.length>=800)break;const m=50,bm=120,x=m+Math.random()*(canvas.width-m*2),y=m+Math.random()*(canvas.height-bm-m),dx=x-gameState.player.x,dy=y-gameState.player.y,d=Math.sqrt(dx*dx+dy*dy);if(d>100)gameState.cigars.push(new Cigar(x,y,gameState.difficulty,z));else i--}}

function checkCigarCatch(){let nearest=null,minDist=Infinity;for(let c of gameState.cigars){if(c.isSmoking)continue;const dx=c.x-gameState.player.x,dy=c.y-gameState.player.y,d=Math.sqrt(dx*dx+dy*dy),cr=(gameState.player.radius+c.radius)*1.5;if(d<cr&&d<minDist){minDist=d;nearest=c}}if(nearest){nearest.isSmoking=true;nearest.smokingStartTime=Date.now();playSound();gameState.phraseCounter++;if(gameState.phraseCounter%3===0)gameState.currentPhrase=phrases[Math.floor(Math.random()*phrases.length)];gameState.smoking={cigar:nearest,startTime:Date.now()}}}

function checkOrderCatch(){for(let i=gameState.orderItems.length-1;i>=0;i--){const o=gameState.orderItems[i];if(o.collected)continue;const dx=o.x-gameState.player.x,dy=o.y-gameState.player.y,d=Math.sqrt(dx*dx+dy*dy);if(d<gameState.player.radius+o.radius){o.collected=true;const bonus=Math.floor(gameState.cigars.length*0.5);spawnCigars(bonus);gameState.orderItems.splice(i,1);gameState.orderMessage=null}}}

function updateGame(){if(!gameState.isPlaying||gameState.isPaused)return;const now=Date.now();gameState.gameTime=Math.floor((now-gameState.gameStartTime)/1000);if(gameState.gameTime>=gameState.maxTime){endGame(false,'timeout');return}const dx=gameState.player.targetX-gameState.player.x,dy=gameState.player.targetY-gameState.player.y;gameState.player.x+=dx*0.15;gameState.player.y+=dy*0.15;gameState.cigars.forEach(c=>c.update(gameState.player.x,gameState.player.y));gameState.orderItems.forEach(o=>o.update(gameState.player.x,gameState.player.y));if(gameState.smoking&&gameState.smoking.cigar.smokingProgress>=2){const idx=gameState.cigars.indexOf(gameState.smoking.cigar);if(idx>-1){gameState.cigars.splice(idx,1);gameState.smokedCount++;gameState.smoking=null}}for(let i=gameState.cigars.length-1;i>=0;i--){if(gameState.cigars[i].isSmoking&&gameState.cigars[i].smokingProgress>=2){gameState.cigars.splice(i,1);gameState.smokedCount++}}checkCigarCatch();checkOrderCatch();const s=difficultySettings[gameState.difficulty],tsl=now-gameState.lastSpawnTime,sp=(tsl/s.spawnInterval)*100;const tb=document.getElementById('spawnTimerBar');if(tb)tb.style.width=Math.max(0,100-sp)+'%';const sus=Math.ceil((s.spawnInterval-tsl)/1000),tt=document.getElementById('spawnTimerText');if(tt)tt.textContent=sus<=0?'Nove cigare sti≈æu!':`Nove cigare za ${sus}s`;if(tsl>s.spawnInterval){spawnCigars(s.spawnCount);gameState.lastSpawnTime=now}if(gameState.cigars.length===0&&gameState.smokedCount>0&&!gameState.smoking)endGame(false,'allSmoked');const tl=Math.max(0,gameState.maxTime-gameState.gameTime);document.getElementById('activeCigars').textContent=gameState.cigars.length;document.getElementById('smokedCigars').textContent=gameState.smokedCount;document.getElementById('timeLeft').textContent=tl+'s'}

function draw(){if(!gameState.isPlaying)return;ctx.clearRect(0,0,canvas.width,canvas.height);gameState.cigars.forEach(c=>c.draw());gameState.orderItems.forEach(o=>o.draw());drawPlayer(gameState.player.x,gameState.player.y);if(gameState.currentPhrase)drawBubble(gameState.player.x,gameState.player.y,gameState.currentPhrase);if(gameState.orderMessage)drawOrderMessage(gameState.player.x,gameState.player.y,gameState.orderMessage);if(!gameState.isPaused)requestAnimationFrame(()=>{updateGame();draw()})}

function showDifficultySelect(){document.getElementById('difficultySelect').classList.add('show')}
function closeDifficultySelect(){document.getElementById('difficultySelect').classList.remove('show')}
function startGame(d){closeDifficultySelect();document.getElementById('intro').style.display='none';gameState={player:{x:canvas.width/2,y:canvas.height/2,radius:35,targetX:canvas.width/2,targetY:canvas.height/2},cigars:[],orderItems:[],smoking:null,smokedCount:0,gameTime:0,maxTime:60,lastSpawnTime:Date.now(),isPlaying:true,isPaused:false,gameStartTime:Date.now(),currentPhrase:null,phraseCounter:0,difficulty:d,orderMessage:null};spawnCigars(difficultySettings[d].startCigars);draw()}

function endGame(won,reason='timeout'){gameState.isPlaying=false;if(gameState.smokedCount>0){const now=new Date();topScores.push({score:gameState.smokedCount,time:gameState.gameTime,difficulty:gameState.difficulty,timestamp:now.getTime(),timeString:now.toLocaleTimeString('sr-RS',{hour:'2-digit',minute:'2-digit'})});topScores.sort((a,b)=>b.score-a.score);topScores=topScores.slice(0,10);localStorage.setItem('hadzijaTopScores',JSON.stringify(topScores))}const dt=gameState.difficulty==='easy'?'Lahko':'Evlijanski';if(reason==='allSmoked'){document.getElementById('gameOver').querySelector('h1').textContent='IZGUBIO SI!';document.getElementById('gameOver').querySelector('.emoji').textContent='üòÖ';document.getElementById('gameOver').querySelector('p').textContent='Prebrzo si popu≈°io sve cigare!';document.getElementById('finalStats').innerHTML=`<strong>Te≈æina:</strong> ${dt}<br><strong>Ispu≈°eno:</strong> ${gameState.smokedCount} cigara<br><strong>Vrijeme:</strong> ${gameState.gameTime}s<br><br><em style="font-size:0.9em;">Cilj je merakaj 60 sekundi!<br>Zovi konobara za vi≈°e cigara!</em>`}else if(gameState.gameTime>=gameState.maxTime){document.getElementById('gameOver').querySelector('h1').textContent='POBJEDIO SI!';document.getElementById('gameOver').querySelector('.emoji').textContent='üéâ';document.getElementById('gameOver').querySelector('p').textContent='Merako si punih 60 sekundi!';document.getElementById('finalStats').innerHTML=`<strong>Te≈æina:</strong> ${dt}<br><strong>Ispu≈°eno:</strong> ${gameState.smokedCount} cigara<br><strong>Vrijeme:</strong> ${gameState.gameTime}s`}document.getElementById('gameOver').classList.add('show');document.getElementById('restartOverlay').classList.remove('show')}

function endGameFromMenu(){closeKonobarMenu();endGame(false,'timeout')}
function restartGame(){document.getElementById('gameOver').classList.remove('show');document.getElementById('restartOverlay').classList.remove('show');showDifficultySelect()}
function exitToMenu(){document.getElementById('gameOver').classList.remove('show');document.getElementById('restartOverlay').classList.remove('show');document.getElementById('intro').style.display='flex';gameState.isPlaying=false;ctx.clearRect(0,0,canvas.width,canvas.height)}
function openKonobarMenu(){gameState.isPaused=true;document.getElementById('konobarMenu').classList.add('show')}
function closeKonobarMenu(){gameState.isPaused=false;document.getElementById('konobarMenu').classList.remove('show');draw()}

function orderItem(name,emoji){gameState.orderMessage=`KONOBAR: Daj jednu ${name}`;closeKonobarMenu();setTimeout(()=>{if(!gameState.isPlaying)return;const m=50,bm=120,x=m+Math.random()*(canvas.width-m*2),y=m+Math.random()*(canvas.height-bm-m);gameState.orderItems.push(new OrderItem(x,y,name,emoji));gameState.orderMessage=null},2000)}

function showTopList(){const c=document.getElementById('topListContent');if(topScores.length===0)c.innerHTML='<div class="empty-list">Jo≈° nema rezultata.<br>Budi prvi!</div>';else{let h='';topScores.forEach((s,i)=>{const m=['ü•á','ü•à','ü•â'][i]||`${i+1}.`,dt=s.difficulty==='easy'?'‚òï Lahko':'üî• Evlijanski';h+=`<div class="top-list-item"><div class="top-list-rank">${m}</div><div class="top-list-info"><div class="top-list-score">${s.score} cigara</div><div class="top-list-details">${dt} ‚Ä¢ ${s.timeString}</div></div><div class="top-list-time">${s.time}s</div></div>`});c.innerHTML=h}document.getElementById('topList').classList.add('show')}
function showTopListFromMenu(){showTopList()}
function showTopListFromGameOver(){document.getElementById('gameOver').classList.remove('show');document.getElementById('restartOverlay').classList.add('show');showTopList()}
function closeTopList(){document.getElementById('topList').classList.remove('show')}
function clearTopScores(){if(confirm('Da li si siguran da ≈æeli≈° obrisati cijelu top listu i resetovati igru?')){localStorage.removeItem('hadzijaTopScores');topScores=[];closeTopList();document.getElementById('gameOver').classList.remove('show');document.getElementById('konobarMenu').classList.remove('show');document.getElementById('difficultySelect').classList.remove('show');document.getElementById('intro').style.display='flex';gameState.isPlaying=false;if(canvas&&ctx)ctx.clearRect(0,0,canvas.width,canvas.height);gameState={player:{x:0,y:0,radius:35,targetX:0,targetY:0},cigars:[],orderItems:[],smoking:null,smokedCount:0,gameTime:0,maxTime:60,lastSpawnTime:0,isPlaying:false,isPaused:false,gameStartTime:0,currentPhrase:null,phraseCounter:0,difficulty:'easy',orderMessage:null};alert('Top lista obrisana i igra resetovana!')}}

function handleInput(e){if(!gameState.isPlaying||gameState.isPaused)return;const r=canvas.getBoundingClientRect();let x,y;if(e.type.startsWith('touch')){e.preventDefault();x=e.touches[0].clientX-r.left;y=e.touches[0].clientY-r.top}else{x=e.clientX-r.left;y=e.clientY-r.top}gameState.player.targetX=x;gameState.player.targetY=y}
canvas.addEventListener('mousemove',handleInput);
canvas.addEventListener('touchmove',handleInput,{passive:false});
canvas.addEventListener('touchstart',handleInput,{passive:false});
    </script>
</body>
</html>
